---
title: "Implementing automated section control sprayers for optimising pesticide application in orchards"
author: "Clemens Stephany, Christoph Weinmann, Lucas Hoffmann, Adrian Fülle, Jasper Hackling"
date: "6/1/2021"
output: html_document
---

\ 

#### Description   
Reducing pesticide use: An analysis on the decision whether to implement an automated or manually operated section control sprayer in orchards.

\ 

#### Decision maker: farmer   
* Farmer is the main stakeholder who makes the decision whether or not to buy a modern sprayer which is able to minimise pesticide application rates

\ 

#### Stakeholders: (describe further)
* Farmer
  + importance: very high
  + Main Decision maker
  + Operator / User (knowledge about relevant orchards)
  + Budget for purchasing costs
  + profitable longterm?
  
* Manufacturer
  + importance: (very) low
  + Supplier
  + (takes feedback into account)

* Government
  + importance: medium - high
  + Bund/Länder - Arbeitsgemeinschaft Wasser (LAWA), Landwirtschaftskammer ...
  + Reduction of pesticide residues and unwanted effects
  + taking probes from products, groundwater, biodiversity (short & longterm)

* Consumers
  + importance: low - mid
  + no residues on products
  + inclined to buy farmers products

* Food retailers
  + same as consumers

* Society  
  + importance: low - mid
  + no active influence / Public image <br/> $\Rightarrow$  influencing government decisions (mindset about eg. Biodiversity)
 
* NGOs
  + importance: mid
  + Greenpeace, newspaper organizations, research centers / institutes
  + influencing society, consumers, government
  + newspaper, magazine article

* Water suppliers
  + importance: mid
  + conservation of healthy water bodies
  + food chains (plankton), fishing grounds, drinking water

* Agro-chemical companies
  + importance: low
  + keeping residues in environment low to prevent restrictive legislation (longterm)
  + BUT less sales of plant protection agents (shortterm)

* Local biodiversity
  + importance: high
  + higher diversity <br/> more pollinators <br/> reduces chance of diseases
  
* Beekeepers
  + importance: low - mid
  + less potential harm to bees


\ 

#### Problems:    
* Some common agrochemicals will be banned in the near future for various reasons
  + Overuse causes problems 
  + Public opinion is getting worse   
* Excessive use of pesticides can cause unwanted effects (e.g. resistances)  
* Agrochemicals are costly supplies <br/> $\Rightarrow$ reduction is welcome  

\ 

#### Options:  
* Buy automatic section control sprayer
* keeping / buying a manual section control sprayer
* Spray less pesticide with existing machinery 
* Adopt organic farming practices <br/> $\Rightarrow$ Use beneficiaries (beneficial organisms)
* Spray manually <br/> $\Rightarrow$ identify areas which need application <br/> $\Rightarrow$ application amount can be imprecise 

\ 

#### Allocation of resources:  
* Money
  + Overheads
  + Overheads        
  + Running costs 
* Labour 
  + Conducting actual tasks 
  + Acquiring know-how
* Pollinators  

\ 

#### Obstacles:  
* Costs of investment
* Learning curve for running the equipment 
* compatibility with current machinery

#### Uncertainties:  
* Potential reduction of pesticides using an automatic section controlled sprayer
  + Especially the reduction of excessive pesticides
* Common application rates of pesticides in orchards
* Potential Cost of an automatic section controlled sprayer
* Changing climate influencing the frequency of pesticides application
* Increased bee survival rate (as there still are pesticides, just less)
* Added value through increased bee survival and thus increasing pollination
* Governmental interest in pesticides reduction
* Image of a farmer trying to reduce pesticides but still using them
* Maintenance cost of an more complicated and sensitive system

#### (Sources of) information:
* Farmers
  + knowledge of the farm, knowledge of problems during application 
* Manufacturer (Currently developing a prototype)
  + Cost and capabilities of an automatic section control sprayer
* Landwirtschaftskammer NRW
  + Potential subsidisation of automatic section control sprayer
  + Political foreshadowing of future legislations
* (commercial) Beekeepers
  + How much of an problem are pesticides
* Consumers
  + Assess the importance/conception of reduced pesticide application to the consumer 



#### Flow chart using diagrammeR package ----  
```{r, include=FALSE}
library(DiagrammeR)
library(DiagrammeRsvg)
library(rsvg)
```


```{r, echo=FALSE}

model_flow_chart <- grViz("

digraph {
  
  # Add general information which counts for everything!!!
  
  # ---------
  # Change flow chart orientation (top down: 'TD'; left to right: 'LR' 
  rankdir = 'LR'
  
  # Add graph statements 
  graph [#label = 'Initial Model',
         labelloc = t,
         fontsize = 45,
         ranksep=2,
         nodesep=1]
  
  # Add node statements
  node [fontname = Arial,
        fontcolor = black,
        color = darkslategray,
        penwidth = 1]
  
  # Add edge statements
  edge [fontsize=30,
        penwidth=2,
        fontname=Arial]
  # ---------  
  
  # ---------  
  # create 'ranks' (basically nodes) for arranging nodes later on
  rank1 [style=invis]
  rank2 [style=invis]
  rank3 [style=invis]
  rank4 [style=invis]
  rank5 [style=invis]
  
  # make invisible (white) links between them
  rank1->rank2->rank3->rank4->rank5 [color=white]
  # ---------  
  
  # ---------  
  # Add specific statements for node group {Intervention & Alternatives} 
  node [shape = box,
        fontsize = 30,
        fixedsize = true,
        width = 3.6,
        height = 1.5]

    Ascs [label = 'Automated section \n control sprayer'];
    Al1 [label = 'Manual section \n control sprayer'];
#    Al2 [label = 'Trittleiter']
  # ---------
  
  
  
  # Add specific statements for node group {Pesticides & Cost} 
  # --------- 
  node [shape = box,
        fontsize = 28,
        fixedsize = true,
        width = 2.8,
        height = 0.9]
  
  Pe [label = 'Pesticides'];
  Co [label = 'Cost']
  
  Cu [label = 'Customers'];          
  Di [label = 'Diseases'];
  Bio [label = 'Biodiversity'];
  WC [label = 'Water \n contamination'];
  
  FS [label = 'Fruit sales'];
  GC [label = 'Government \n concerns'];
  
  FP [label = 'Farmers profit']
  
  # ---------  
  
  
  # Add edge statements for negative connection (arrows) and add the connections
  # ---------  
  edge [label = '-    ',
        fontcolor = 'red',
        color = 'red']
  {Ascs Al1}->Pe
#  Al2->Pe
  Pe->{Bio Di Cu}
  GC->FP
  WC->Bio
  Bio->{Di GC}
  Di->FS
  Co->FP
  # ---------  
  
  # Add edge statements for positive connection (arrows) and add the connections
  # ---------  
  edge [label = '+',
        fontcolor = 'forestgreen',
        color = 'forestgreen']
  
  {Ascs Al1}->Co
#  Al2->Co
  Pe->{WC Co} 
  FS->FP 
  WC->GC 
  Bio->FS
  Cu->FS
  # ---------  
  
  # ---------  
  # sorting the nodes per rank
  
  {
    rank1 -> Ascs -> Al1 [style=invis];
    # rank1 -> Ascs -> Al1 -> Al2 [style=invis];
    rank=same;
    rankdir=DT;
  }
  
  {
    rank2 -> Co -> Pe [style=invis];
    rank=same;
    rankdir=DT;
  }
  
  {
    rank3 -> Di -> Cu -> Bio -> WC [style=invis];
    rank=same;
    rankdir=DT;
  }
  
  # {
  #   rank4 -> FS -> GC [style=invis];
  #   rank=same;
  #   rankdir=DT;
  # }
# 
#   {
#     rank5 -> FS [style=invis];
#     rank=same;
#     rankdir=DT;
#   }
#   
  # ---------  
  
}")



# Plot flow chart 
model_flow_chart

# Export flow chart as .png files; save in "images" folder 
rsvg_png(charToRaw(export_svg(model_flow_chart)), "images/flow-chart.png") 

```


#### First model 

<!-- Not finished yet -->
<!-- #### Calculating the decision model {.tabset} -->
<!-- ##### Input -->
<!-- ```{r echo = FALSE} -->
<!-- # Input table for model function, adding Management_cost -->

<!-- input_estimates <- data.frame(variable = c("Farmers Profit", "Automated section control", "Pesticides", "Water contamination", " Customers", "Government concerns", "Biodiversity", "Diseases", "Fruit sales"), -->
<!--                               lower = c(6000, 3, 500, 100), -->
<!--                               median = NA, -->
<!--                               upper = c(14000, 8, 1000, 2000), -->
<!--                               distribution = c("posnorm", "posnorm", "posnorm", "posnorm"), -->
<!--                               label = c("Yield (kg/ha)", "Price (USD/kg)", "Labor cost (USD/ha)", "Management cost (USD/ha)"), -->
<!--                               Description = c("Yield in a sweet cherry farm under normal conditions", -->
<!--                                               "Price of sweet cherry in a normal season", -->
<!--                                               "Labor costs in a normal season",  -->
<!--                                               "Management costs in a normal season")) -->

<!-- ## Changing some columns as they are not in the right format (addition, maybe because R-base 3.6.3?) -->
<!-- input_estimates$distribution <- as.character(input_estimates$distribution) -->
<!-- input_estimates$variable <- as.character(input_estimates$variable) -->

<!-- # Show input_estimates table -->
<!-- input_estimates -->
<!-- ``` -->

<!-- ##### Model -->
<!-- ```{r} -->
<!-- # Creating model function to describe the graphical impact pathway (Diagram done earlier) -->
<!-- model_function <- function(){ -->

<!--   # Estimate the income in a normal season -->
<!--   income <- Yield * Market_price -->

<!--   # Estimate the overall cost in a normal season -->
<!--   overall_cost <- Labor_cost + Management_cost -->

<!--   # Estimate the final results from the model -->
<!--   final_result <- income - overall_cost -->

<!--   # Generate the list of outputs from the Monte Carlo simulation -->
<!--   return(list(final_result = final_result)) -->
<!-- } -->

<!-- # Run the Monte Carlo simulation using the model function -->
<!-- mc_simulation <- mcSimulation(estimate = as.estimate(input_estimates), -->
<!--                                     model_function = model_function, -->
<!--                                     numberOfModelRuns = 1000000, -->
<!--                                     functionSyntax = "plainNames") -->

<!-- # Print MonteCarlo simulation output -->
<!-- # mc_simulation -->

<!-- # Function for creating a random variable for a column from the input_estimates table  -->
<!-- # and put it in the global Env. for test purposes (faster that running whole model) -->
<!-- make_variables <- function(est,n=1) -->
<!-- { x<-random(rho=est, n=n) -->
<!-- for(i in colnames(x)) assign(i, -->
<!--                              as.numeric(x[1,i]),envir=.GlobalEnv) -->
<!-- } -->

<!-- # Creating random global variable from input_estimates -->
<!-- make_variables(as.estimate(input_estimates)) -->

<!-- # Call function (without parameters as they are in the global environment) -->
<!-- model_function() -->
<!-- ``` -->

<!-- ##### Graph {.active} -->
<!-- ```{r, echo=FALSE} -->

<!-- # Plot distributions to show outcome -->
<!-- plot_distributions(mcSimulation_object = mc_simulation, -->
<!--                    vars = "final_result", -->
<!--                    method = "hist_simple_overlay", -->
<!--                    old_names = "final_result", -->
<!--                    new_names = "Outcome distribution for profits") -->

<!-- ``` -->




#### Notes for improvement from the seminar 


**Inspiration from other presentations**  

* Implement "interception" aspect at the base of the model  
* End model with "Overall value"/"NPV" instead of "Farmer's profit" 
* Add legend to the model visualisation  


**Suggestions to improve our model**  
* Orchard size:
  + Keep applicability to many different situations in minds 
  + Create a number of realistic scenarios 
* Estimate maximum area one unit can work on $\Rightarrow$ Set maximum workload as upper boundary 
  + Consider max. speed, max. uninterrupted working hours 
 
 
 
#### Example code from Seminar 08 and Seminar 09 

```{r, include = FALSE}
library(decisionSupport)
library(readr)
library(tidyverse)
library(ggplot2)
library(plyr)
library(dplyr)
library(igraph)
```

```{r, echo = FALSE}
### Seminar 08


## Building a decision model as an R function 

example_decision_function <- function(x, varnames){
  
  # calculate ex-ante risks: impact the implementation of interventions ####
  intervention_NonPopInvolvEvent <-
    chance_event(intervention_NonPopInvolv, 1, 0, n = 1)
  
  # pre-calculate common random draws for all intervention model runs ####
  
  # profits from Tropical Livestock Units (TLU)
  TLU <- vv(TLU_no_intervention, var_CV, n_years)
  TLU_profit <- vv(profit_per_TLU, var_CV, n_years)
  
  # benefits of fruit
  precalc_intervention_fruit_benefits <-
    vv(intervention_fruit_area_ha, var_CV, n_years) *
    vv(intervention_fruit_yield_t_ha, var_CV, n_years) *
    vv(intervention_fruit_profit_USD_t, var_CV, n_years)
  
  # benefits of vegetables
  precalc_intervention_vegetable_benefits <-
    vv(intervention_vegetable_area_ha, var_CV, n_years) *
    vv(intervention_vegetable_yield_t_ha, var_CV, n_years) *
    vv(intervention_vegetable_profit_USD_t, var_CV, n_years)
  
  # benefits of rain-fed crops
  precalc_intervention_rainfed_crop_benefits <-
    vv(intervention_rainfed_crop_area_ha, var_CV, n_years) *
    vv(intervention_rainfed_crop_yield_t_ha, var_CV, n_years) *
    vv(intervention_rainfed_crop_profit_USD_t, var_CV, n_years)
  
  #  Intervention ####
  
  for (decision_intervention_strips in c(FALSE,TRUE))
      {
      
  if (decision_intervention_strips)
  {
    intervention_strips <- TRUE
    intervention_strips_PlanningCost <- TRUE
    intervention_strips_cost <- TRUE
  } else
  {
    intervention_strips <- FALSE
    intervention_strips_PlanningCost <- FALSE
    intervention_strips_cost <- FALSE
  }
  
  if (intervention_NonPopInvolvEvent) {
    intervention_strips <- FALSE
    intervention_strips_cost <- FALSE
  }
  
  # Costs ####
  if (intervention_strips_cost) {
    cost_intervention_strips <-
      intervention_adaptation_cost + 
      intervention_tech_devices_cost + 
      intervention_nursery_cost +
      intervention_wells_cost +
      intervention_training_cost + 
      intervention_mngmt_oprt_cost + 
      intervention_mngmt_follow_cost +
      intervention_mngmt_audit_cost
  } else
    cost_intervention_strips <- 0
  
  if (intervention_strips_PlanningCost) {
    plan_cost_intervention_strips <-
      intervention_communication_cost + intervention_zoning_cost
  } else
    plan_cost_intervention_strips <- 0
  
  maintenance_cost <- rep(0, n_years)
  
  if (intervention_strips)
    maintenance_cost <-
    maintenance_cost + vv(maintenance_intervention_strips, 
                          var_CV, n_years)
  
  intervention_cost <- maintenance_cost
  intervention_cost[1] <-
    intervention_cost[1] + 
    cost_intervention_strips + 
    plan_cost_intervention_strips

  
  # Benefits from  cultivation in the intervention strips ####
  
  intervention_fruit_benefits <-
    as.numeric(intervention_strips) * precalc_intervention_fruit_benefits
  intervention_vegetable_benefits <-
    as.numeric(intervention_strips) * precalc_intervention_vegetable_benefits
  intervention_rainfed_crop_benefits <-
    as.numeric(intervention_strips) * precalc_intervention_rainfed_crop_benefits
  
  # Total benefits from crop production (agricultural development and riparian zone) ####
  crop_production <-
    intervention_fruit_benefits +
    intervention_vegetable_benefits +
    intervention_rainfed_crop_benefits
  
  # Benefits from livestock ####
  # The following allows considering that intervention strips may
  # restrict access to the reservoir for livestock.
  
  if (intervention_strips)
    TLU_intervention <-
    TLU * (1 + change_TLU_intervention_perc / 100)
  else
    TLU_intervention <- TLU
  
  if (decision_intervention_strips){
    livestock_benefits <- TLU_intervention * TLU_profit
    total_benefits <- crop_production + livestock_benefits
    net_benefits <- total_benefits - intervention_cost
    result_interv <- net_benefits}
  
  
  if (!decision_intervention_strips){
    livestock_benefits <- TLU_no_intervention * TLU_profit
    total_benefits <- livestock_benefits
    net_benefits <- total_benefits - intervention_cost
    result_n_interv <- net_benefits}
  
    } #close intervention loop bracket

NPV_interv <-
  discount(result_interv, discount_rate, calculate_NPV = TRUE)

NPV_n_interv <-
  discount(result_n_interv, discount_rate, calculate_NPV = TRUE)

# Beware, if you do not name your outputs 
# (left-hand side of the equal sign) in the return section, 
# the variables will be called output_1, _2, etc.

return(list(Interv_NPV = NPV_interv,
            NO_Interv_NPV = NPV_n_interv,
            NPV_decision_do = NPV_interv - NPV_n_interv,
            Cashflow_decision_do = result_interv - result_n_interv))
}


## Importing input table 
input_table <- read.csv("data/example_input_table.csv")


## Perform a Monte Carlo simulation 
mcSimulation_results <- decisionSupport::mcSimulation(
  estimate = decisionSupport::estimate_read_csv("data/example_input_table.csv"),
  model_function = example_decision_function,
  numberOfModelRuns = 200,
  functionSyntax = "plainNames"
)


## Plot Net Present Value (NPV) distributions 
decisionSupport::plot_distributions(mcSimulation_object = mcSimulation_results, 
                                    vars = c("Interv_NPV", "NO_Interv_NPV"),
                                    method = 'smooth_simple_overlay', 
                                    base_size = 7)

decisionSupport::plot_distributions(mcSimulation_object = mcSimulation_results, 
                                    vars = c("Interv_NPV",
                                    "NO_Interv_NPV"),
                                    method = 'boxplot')

decisionSupport::plot_distributions(mcSimulation_object = mcSimulation_results, 
                                    vars = "NPV_decision_do",
                                    method = 'boxplot_density')


## Cashflow analysis 
plot_cashflow(mcSimulation_object = mcSimulation_results, cashflow_var_name = "Cashflow_decision_do")


## Projection to Latent Structures (PLS) analysis 
pls_result <- plsr.mcSimulation(object = mcSimulation_results,
                  resultName = names(mcSimulation_results$y)[3], ncomp = 1)

plot_pls(pls_result, input_table = input_table, threshold = 0)


## Value of information (VoI) analysis 

# Here we subset the outputs from the mcSimulation function (y) by selecting the correct variables
# choose this carefully and be sure to run the multi_EVPI only on the variables that the you want
mcSimulation_table <- data.frame(mcSimulation_results$x, mcSimulation_results$y[1:3])

evpi <- multi_EVPI(mc = mcSimulation_table, first_out_var = "Interv_NPV")

plot_evpi(evpi, decision_vars = "NPV_decision_do")

compound_figure(mcSimulation_object = mcSimulation_results, 
                input_table = input_table, plsrResults = pls_result, 
                EVPIresults = evpi, decision_var_name = "NPV_decision_do", 
                cashflow_var_name = "Cashflow_decision_do", 
                base_size = 7)
```


```{r, echo = FALSE}
### Seminar 09


## Plot impact pathway
hail_path <- graph.formula(HailNet -+ Yield, 
                           HailNet -+ Cost, 
                           HailEvent -+ Yield,
                           Yield -+ MarketPrice, 
                           MarketPrice -+ NPV,
                           Cost -+ NPV)
plot(hail_path)


## Building the model 
hail_estimates <- data.frame(variable = c("yield", 
                                          "var_CV", 
                                          "initial_investment", 
                                          "price", 
                                          "p_hail"),
                    lower = c(6000, 20, 500, 5, 0.02),
                    median = NA,
                    upper = c(14000, 20, 1000, 80, 0.2),
                    distribution = c("posnorm", 
                                     "const", 
                                     "posnorm", 
                                     "posnorm",
                                     "posnorm"),
                    label = c("Yield (kg/ha)", 
                              "Coefficient of variation", 
                              "Investment cost (USD)", 
                              "Market price (EUR/kg)", 
                              "% chance hail"),
                    Description = c("Yield under normal conditions",
                                    "Coefficient of variation (measure of relativevariability)",
                                    "Investment cost", 
                                    "Market price achieved for yields (EUR/kg)", 
                                    "Probability of a hail storm"))
hail_estimates


## Create a function following the graphical impact pathway and using the inputs above to calculate the Net Present Value for the investment

hail_function <- function(){
  
# use vv() to add variability to the random draws of yield and of price over a 20 year simulation 
yields <- vv(var_mean = yield, 
             var_CV = var_CV, 
             n = 20)

prices <- vv(var_mean = price, 
             var_CV = var_CV, 
             n = 20)

# use rep() to simulate the initial_investment 
# only in the first year (assuming the net lasts 20 years)
invest_costs <- c(initial_investment, rep(0, 19))

# use p_hail in the chance_event() 
# to adjust yield for probability of hail
# assuming no yield at all in the event of hail
hail_adjusted_yield <- chance_event(chance = p_hail, 
                                    value_if = 0,
                                    value_if_not = yield,
                                    n = 20)

# calculate profit without net
profit_no_net <- hail_adjusted_yield*prices

# calculate profit with the net
profit_with_net <- (yields*prices)-invest_costs

# use 'discount' to calculate net present value 
# 'discount_rate' is expressed in percent
NPV_no_net <- discount(profit_no_net, discount_rate = 5, calculate_NPV = TRUE)
NPV_net <- discount(profit_with_net, discount_rate = 5, calculate_NPV = TRUE)

# calculate the overall NPV of the decision (do - don't do)
NPV_decision <- NPV_net-NPV_no_net

return(list(NPV_no_net =  NPV_no_net,
            NPV_net =  NPV_net, 
            NPV_decision = NPV_decision))
}


## Run the Monte Carlo simulation using the model function
hail_mc_simulation <- mcSimulation(estimate = as.estimate(hail_estimates),
                                   model_function = hail_function,
                                   numberOfModelRuns = 200,
                                   functionSyntax = "plainNames")
hail_mc_simulation


## Results of Monte Carlo simulation (200 model runs) for estimating comparative profits with/without hail nets
plot_distributions(mcSimulation_object = hail_mc_simulation, 
                   vars = c("NPV_no_net", "NPV_net"),
                   method = 'smooth_simple_overlay', 
                   base_size = 7)


## Value of Information (VoI) analysis 

# Subset outputs from mcSimulation function (y) to run multi_EVPI only on variables that we want 
# (i.e. the NPV_decision)
mcSimulation_table_hail <- data.frame(hail_mc_simulation$x, 
                                      hail_mc_simulation$y[3])

evpi_hail <- multi_EVPI(mc = mcSimulation_table_hail,    # calculate EVPI for multiple independent variables
                        first_out_var = "NPV_decision")

plot_evpi(evpi_hail, decision_vars = "NPV_decision")
```

