---
title: "Implementing automated section control sprayers for optimising pesticide application in orchards"
author: "Clemens Stephany, Christoph Weinmann, Lucas Hoffmann, Adrian Fülle, Jasper Hackling"
date: "6/1/2021"
output: html_document
bibliography: 
  - bib/references.bib
---

Test: Referencing literature
Read Do et al. [@do_decision_2020]



#### Introduction ####

**Decision Analysis**  
* Forecasting the performance of an intervention with the help of models can aid management decisions * New practices and the systems they are planned to be implemented in need to be analysed realistically and holistically  
* It is important to openly disclose and discuss uncertainties $\rightarrow$ use distributions instead of fixed input values 
* Decision analysis in agricultural development
  + How will decisions influence future sustainability? 
  + Goal: Offer support in decision making under uncertainty 
  + Approach: Making use of existing knowledge to build forecasts 
* What is a decision in this context? 
  + Logical choice between two different interventions options 
  + Irrevocable allocation of resources 
* Impact pathways
  + Helpful to think the consequences of a decision through beforehand $\rightarrow$ identify weak links 

**Automated section control sprayer** 
* Traditional sprayers cannot easily adapt application rates to changing requirements 
  + $\rightarrow$ More pesticide than necessary is applied  
* In order to reduce pesticide application rates, farmers can upgrade to section control-enabled sprayers  
* Current innovation for orchards: Automated vertical section control sprayers promise superior performance compared to manually operated units and those with fixed application rates 



\ 

#### Description ----
Reducing pesticide use: An analysis on the decision whether to implement an automated or manually operated section control sprayer in orchards.

\ 

#### Decision maker: farmer ----   
* Farmer is the main stakeholder who makes the decision whether or not to buy a modern sprayer which is able to minimise pesticide application rates

\ 

#### Stakeholders: (describe further) ----
* Farmer
  + importance: very high
  + Main Decision maker
  + Operator / User (knowledge about relevant orchards)
  + Budget for purchasing costs
  + profitable longterm?
  
* Manufacturer
  + importance: (very) low
  + Supplier
  + (takes feedback into account)

* Government
  + importance: medium - high
  + Bund/Länder - Arbeitsgemeinschaft Wasser (LAWA), Landwirtschaftskammer ...
  + Reduction of pesticide residues and unwanted effects
  + taking probes from products, groundwater, biodiversity (short & longterm)

* Consumers
  + importance: low - mid
  + no residues on products
  + inclined to buy farmers products

* Food retailers
  + same as consumers

* Society  
  + importance: low - mid
  + no active influence / Public image <br/> $\Rightarrow$  influencing government decisions (mindset about eg. Biodiversity)
 
* NGOs
  + importance: mid
  + Greenpeace, newspaper organizations, research centers / institutes
  + influencing society, consumers, government
  + newspaper, magazine article

* Water suppliers
  + importance: mid
  + conservation of healthy water bodies
  + food chains (plankton), fishing grounds, drinking water

* Agro-chemical companies
  + importance: low
  + keeping residues in environment low to prevent restrictive legislation (longterm)
  + BUT less sales of plant protection agents (shortterm)

* Local biodiversity
  + importance: high
  + higher diversity <br/> more pollinators <br/> reduces chance of diseases
  
* Beekeepers
  + importance: low - mid
  + less potential harm to bees


\ 

#### Problems ----    
* Some common agrochemicals will be banned in the near future for various reasons
  + Overuse causes problems 
  + Public opinion is getting worse   
* Excessive use of pesticides can cause unwanted effects (e.g. resistances)  
* Agrochemicals are costly supplies <br/> $\Rightarrow$ reduction is welcome  

\ 

#### Options ---- 
* Buy automatic section control sprayer
* keeping / buying a manual section control sprayer
* Spray less pesticide with existing machinery 
* Adopt organic farming practices <br/> $\Rightarrow$ Use beneficiaries (beneficial organisms)
* Spray manually <br/> $\Rightarrow$ identify areas which need application <br/> $\Rightarrow$ application amount can be imprecise 

\ 

#### Allocation of resources ---- 
* Money
  + Overheads
  + Overheads        
  + Running costs 
* Labour 
  + Conducting actual tasks 
  + Acquiring know-how
* Pollinators  

\ 

#### Obstacles ----
* Costs of investment
* Learning curve for running the equipment 
* compatibility with current machinery

#### Uncertainties ----
* Potential reduction of pesticides using an automatic section controlled sprayer
  + Especially the reduction of excessive pesticides
* Common application rates of pesticides in orchards
* Potential Cost of an automatic section controlled sprayer
* Changing climate influencing the frequency of pesticides application
* Increased bee survival rate (as there still are pesticides, just less)
* Added value through increased bee survival and thus increasing pollination
* Governmental interest in pesticides reduction
* Image of a farmer trying to reduce pesticides but still using them
* Maintenance cost of an more complicated and sensitive system

#### (Sources of) information ----
* Farmers
  + knowledge of the farm, knowledge of problems during application 
* Manufacturer (Currently developing a prototype)
  + Cost and capabilities of an automatic section control sprayer
* Landwirtschaftskammer NRW
  + Potential subsidisation of automatic section control sprayer
  + Political foreshadowing of future legislations
* (commercial) Beekeepers
  + How much of an problem are pesticides
* Consumers
  + Assess the importance/conception of reduced pesticide application to the consumer 



#### Flow chart using diagrammeR package ----  
```{r, eval=FALSE}
library(decisionSupport)
library(DiagrammeR)
library(DiagrammeRsvg)
library(rsvg)
library(tidyverse)
```


```{r, eval=FALSE}

model_flow_chart <- grViz("

digraph {
  
  # Add general information which counts for everything!!!
  
  # ---------
  # Change flow chart orientation (top down: 'TD'; left to right: 'LR' 
  rankdir = 'LR'
  
  # Add graph statements 
  graph [#label = 'Initial Model',
         labelloc = t,
         fontsize = 45,
         ranksep=2,
         nodesep=1]
  
  # Add node statements
  node [fontname = Arial,
        fontcolor = black,
        color = darkslategray,
        penwidth = 1]
  
  # Add edge statements
  edge [fontsize=30,
        penwidth=2,
        fontname=Arial]
  # ---------  
  
  # ---------  
  # create 'ranks' (basically nodes) for arranging nodes later on
  rank1 [style=invis]
  rank2 [style=invis]
  rank3 [style=invis]
  rank4 [style=invis]
  rank5 [style=invis]
  
  # make invisible (white) links between them
  rank1->rank2->rank3->rank4->rank5 [color=white]
  # ---------  
  
  # ---------  
  # Add specific statements for node group {Intervention & Alternatives} 
  node [shape = box,
        fontsize = 30,
        fixedsize = true,
        width = 3.6,
        height = 1.5]

    Ascs [label = 'Automated section \n control sprayer'];
    Al1 [label = 'Manual section \n control sprayer'];
  # ---------
  
  
  
  # Add specific statements for node group {Pesticides & Cost} 
  # --------- 
  node [shape = box,
        fontsize = 28,
        fixedsize = true,
        width = 2.8,
        height = 0.9]
  
  Pe [label = 'Pesticides'];
  Co [label = 'Cost']
  
  Cu [label = 'Customers'];          
  Di [label = 'Plant damage'];
  Bio [label = 'Biodiversity'];
  WC [label = 'Water \n contamination'];
  
  FS [label = 'Fruit sales'];
  GC [label = 'Government \n concerns'];
  
  FP [label = 'Farmers profit']
  
  # ---------  
  
  
  # Add edge statements for negative connection (arrows) and add the connections
  # ---------  
  edge [label = '-    ',
        fontcolor = 'red',
        color = 'red']
  {Ascs Al1} -> Pe #[headport = w, tailport = e]
  GC -> Pe
  Pe->Bio #[headport = w]
  Pe-> Di 
  Bio->{Di GC}
  WC->{Bio Cu}
  Di->FS
  Co->FP
  # ---------  
  
  # Add edge statements for positive connection (arrows) and add the connections
  # ---------  
  edge [label = '+',
        fontcolor = 'forestgreen',
        color = 'forestgreen']
  
  {Ascs Al1}->Co #[headport = w, tailport = s]
  Pe-> WC  #[headport = w, tailport = n]
  Pe-> Co
  FS->FP 
  WC->GC 
  Bio-> Cu
#  Di -> Pe
  Cu->FS
  # ---------  
  
  # ---------  
  # sorting the nodes per rank
  
  {
    Ascs -> Al1 -> rank1 [style=invis];
    rank=same;
    rankdir=TD;
  }
  
  {
    Co -> Pe -> GC -> rank2 [style=invis];
    rank=same;
    rankdir=TD;
  }
  
  {
    Di -> Bio -> WC -> rank3 [style=invis];
    rank=same;
    rankdir=TD;
  }
  
  {
    Cu -> FS -> rank4 [style=invis];
    rank=same;
    rankdir=TD;
  }
 
#   {
#     rank5 -> FS [style=invis];
#     rank=same;
#     rankdir=DT;
#   }
#   
  # ---------  
  
}")



# Plot flow chart 
model_flow_chart

# Export flow chart as .png files; save in "images" folder 
rsvg_png(charToRaw(export_svg(model_flow_chart)), "images/flow-chart.png") 

```


<<<<<<< HEAD
#### First model ----

<!-- Not finished yet -->
<!-- #### Calculating the decision model {.tabset} -->
<!-- ##### Input -->
<!-- ```{r echo = FALSE} -->
<!-- # Input table for model function, adding Management_cost -->

<!-- input_estimates <- data.frame(variable = c("Farmers Profit", "Automated section control", "Pesticides", "Water contamination", " Customers", "Government concerns", "Biodiversity", "Diseases", "Fruit sales"), -->
<!--                               lower = c(6000, 3, 500, 100), -->
<!--                               median = NA, -->
<!--                               upper = c(14000, 8, 1000, 2000), -->
<!--                               distribution = c("posnorm", "posnorm", "posnorm", "posnorm"), -->
<!--                               label = c("Yield (kg/ha)", "Price (USD/kg)", "Labor cost (USD/ha)", "Management cost (USD/ha)"), -->
<!--                               Description = c("Yield in a sweet cherry farm under normal conditions", -->
<!--                                               "Price of sweet cherry in a normal season", -->
<!--                                               "Labor costs in a normal season",  -->
<!--                                               "Management costs in a normal season")) -->

<!-- ## Changing some columns as they are not in the right format (addition, maybe because R-base 3.6.3?) -->
<!-- input_estimates$distribution <- as.character(input_estimates$distribution) -->
<!-- input_estimates$variable <- as.character(input_estimates$variable) -->

<!-- # Show input_estimates table -->
<!-- input_estimates -->
<!-- ``` -->

<!-- ##### Model -->
<!-- ```{r} -->
<!-- # Creating model function to describe the graphical impact pathway (Diagram done earlier) -->
<!-- model_function <- function(){ -->

<!--   # Estimate the income in a normal season -->
<!--   income <- Yield * Market_price -->

<!--   # Estimate the overall cost in a normal season -->
<!--   overall_cost <- Labor_cost + Management_cost -->

<!--   # Estimate the final results from the model -->
<!--   final_result <- income - overall_cost -->

<!--   # Generate the list of outputs from the Monte Carlo simulation -->
<!--   return(list(final_result = final_result)) -->
<!-- } -->

<!-- # Run the Monte Carlo simulation using the model function -->
<!-- mc_simulation <- mcSimulation(estimate = as.estimate(input_estimates), -->
<!--                                     model_function = model_function, -->
<!--                                     numberOfModelRuns = 1000000, -->
<!--                                     functionSyntax = "plainNames") -->

<!-- # Print MonteCarlo simulation output -->
<!-- # mc_simulation -->

<!-- # Function for creating a random variable for a column from the input_estimates table  -->
<!-- # and put it in the global Env. for test purposes (faster that running whole model) -->
<!-- make_variables <- function(est,n=1) -->
<!-- { x<-random(rho=est, n=n) -->
<!-- for(i in colnames(x)) assign(i, -->
<!--                              as.numeric(x[1,i]),envir=.GlobalEnv) -->
<!-- } -->

<!-- # Creating random global variable from input_estimates -->
<!-- make_variables(as.estimate(input_estimates)) -->

<!-- # Call function (without parameters as they are in the global environment) -->
<!-- model_function() -->
<!-- ``` -->

<!-- ##### Graph {.active} -->
<!-- ```{r, echo=FALSE} -->

<!-- # Plot distributions to show outcome -->
<!-- plot_distributions(mcSimulation_object = mc_simulation, -->
<!--                    vars = "final_result", -->
<!--                    method = "hist_simple_overlay", -->
<!--                    old_names = "final_result", -->
<!--                    new_names = "Outcome distribution for profits") -->

<!-- ``` -->




#### Notes for improvement from the seminar ---- 


**Inspiration from other presentations**  

* Implement "interception" aspect at the base of the model  
* End model with "Overall value"/"NPV" instead of "Farmer's profit" 
* Add legend to the model visualisation  


**Suggestions to improve our model**  
* Orchard size:
  + Keep applicability to many different situations in minds 
  + Create a number of realistic scenarios 
* Estimate maximum area one unit can work on $\Rightarrow$ Set maximum workload as upper boundary 
  + Consider max. speed, max. uninterrupted working hours 
 
 
 
#### Example code from Seminar 08 and Seminar 09 ---- 

```{r, eval = FALSE}
library(decisionSupport)
library(readr)
library(tidyverse)
library(ggplot2)
library(plyr)
library(dplyr)
library(igraph)
```

```{r, eval = FALSE}
### Seminar 08


## Building a decision model as an R function 

example_decision_function <- function(x, varnames){
  
  # calculate ex-ante risks: impact the implementation of interventions ####
  intervention_NonPopInvolvEvent <-
    chance_event(intervention_NonPopInvolv, 1, 0, n = 1)
  
  # pre-calculate common random draws for all intervention model runs ####
=======
#### First model 
  
```

```{r, eval = FALSE}

ascs_decision_model <- function(x, varnames){
  

  # the amount of used pesticides can vary depending on weather forecasts (factor from 0.7 - 1.3)
  # and infestation/disease levels but this is integrated through a correlation with plant_damage
  # quantity varies for manual and automated sprayer 
  # pest_quant_man <- vv( pesticide_quantity, var_CV, n_years)
  # pest_quant_aut <- pest_quant_man * pesticide_reduction_auto 

  # application efficiency (tree distance and how much it saves to not spray in between)
  # the efficiency is fix over the years per model run 
  
  
  
  # iterative pesticide impact
  auxilary_table <- data.frame(year = c(1:n_years),
                               pest_quant_man = rep(0.,n_years),
                               pest_quant_aut = rep(0.,n_years),
                               rel_water_cont_man = rep(0.,n_years),
                               rel_water_cont_aut = rep(0.,n_years),
                               rel_bio_man = rep(0.,n_years),
                               rel_bio_aut = rep(0.,n_years),
                               plant_dmg_pot_man = rep(0.,n_years),
                               plant_dmg_pot_aut = rep(0.,n_years),
                               actual_plant_dmg_man = rep(0.,n_years),
                               actual_plant_dmg_aut = rep(0.,n_years),
                               gov_inter_chance = rep(0.,n_years),
                               gov_inter_happened = rep(0,n_years))
  

  for (y in 1:n_years) {
    
    if (y == 1) {
      # general chance that government intervenes
      auxilary_table$gov_inter_chance_man[y] <- government_intervention_chance 
      auxilary_table$gov_inter_chance_aut[y] <- auxilary_table$gov_inter_chance_man[y]
      auxilary_table$gov_inter_happened_man[y] <- chance_event(auxilary_table$gov_inter_chance_man[y], 1, 0, 1)
      auxilary_table$gov_inter_happened_aut[y] <- chance_event(auxilary_table$gov_inter_chance_aut[y], 1, 0, 1)

      # pesticide on water contamination influence factor ## fix per run
      pest_cont_fac <- vv(pesticide_on_water_contamination_factor, var_CV, 1)
      # pesticide on biodiversity influence factor ## fix per run
      pest_bio_fac <- vv(pesticide_on_biodiversity_factor, var_CV, 1)
      # water contamination on biodiversity factor ## fix per run
      cont_bio_fac <- vv(water_contamination_on_biodiversity_factor, var_CV, 1)
      # pestizide reduction factor
      pest_red_fac <- pesticide_reduction_auto
      # potential plant damage 
      auxilary_table$plant_dmg_pot_man[y] <- potential_plant_damage
      # vv(potential_plant_damage, var_CV, n_years, lower_limit = 0.7,upper_limit = 1.3)   
      # vv( potential_plant_damage, 0, n_years)
      auxilary_table$plant_dmg_pot_aut[y] <- auxilary_table$plant_dmg_pot_man[y]
      # pesticide quantity
      auxilary_table$pest_quant_man[y] <- pesticide_quantity     # vv( pesticide_quantity, var_CV, n_years)
      auxilary_table$pest_quant_aut[y] <- auxilary_table$pest_quant_man[y] * pest_red_fac
      # water contamination 
      auxilary_table$rel_water_cont_man[y] <- 1 # rep(1, n_years)
      auxilary_table$rel_water_cont_aut[y] <- 1 # rep(1, n_years)
      # biodiversity
      auxilary_table$rel_bio_man[y] <- 1 # rep(1, n_years)
      auxilary_table$rel_bio_aut[y] <- 1 # rep(1, n_years)
      auxilary_table$pest_quant_man[y] <- ifelse(auxilary_table$gov_inter_happened_man[y] == 0,
                                                 auxilary_table$pest_quant_man[y],
                                                 ifelse(auxilary_table$pest_quant_man[y] > government_pesticide_quantity,
                                                        government_pesticide_quantity,
                                                        auxilary_table$pest_quant_man[y]))
      
      auxilary_table$pest_quant_aut[y] <- ifelse(auxilary_table$gov_inter_happened_aut[y] == 0,
                                                 auxilary_table$pest_quant_aut[y],
                                                 ifelse(auxilary_table$pest_quant_aut[y] > government_pesticide_quantity,
                                                        government_pesticide_quantity,
                                                        auxilary_table$pest_quant_aut[y]))
      # actual plant damage         
      actual_plant_dmg_man <- auxilary_table$plant_dmg_pot_man[y] - auxilary_table$pest_quant_man[y]
      ### auxilary_table$actual_plant_dmg_man[y] <- actual_plant_dmg_man
      auxilary_table$actual_plant_dmg_man[y] <- ifelse(actual_plant_dmg_man<0,0,actual_plant_dmg_man)
      actual_plant_dmg_aut <- auxilary_table$plant_dmg_pot_aut[y] - auxilary_table$pest_quant_aut[y] / pest_red_fac
      ### auxilary_table$actual_plant_dmg_aut[y] <- actual_plant_dmg_aut
      auxilary_table$actual_plant_dmg_aut[y] <- ifelse(actual_plant_dmg_aut<0,0,actual_plant_dmg_aut)
      
      }else  {
      # general chance affected by biodiversity and water contamination that government intervenes
      auxilary_table$gov_inter_chance_man[y] <- auxilary_table$gov_inter_chance_man[y-1] +
        ( ((1 - auxilary_table$rel_bio_man[y-1]) * biodiversity_on_gov_concern) + 
            ((auxilary_table$rel_water_cont_man[y-1] - 1) * water_contamination_on_gov_concern))
      auxilary_table$gov_inter_chance_aut[y] <- auxilary_table$gov_inter_chance_aut[y-1] +
        ( ((1 - auxilary_table$rel_bio_aut[y-1]) * biodiversity_on_gov_concern) + 
            ((auxilary_table$rel_water_cont_aut[y-1] - 1) * water_contamination_on_gov_concern))

      auxilary_table$gov_inter_chance_aut[y] <- auxilary_table$gov_inter_chance_aut[y-1] +
        ( ((1 - auxilary_table$rel_bio_aut[y-1]) * biodiversity_on_gov_concern) + 
            ((auxilary_table$rel_water_cont_aut[y-1] - 1) * water_contamination_on_gov_concern))
      auxilary_table$gov_inter_chance_aut[y] <- auxilary_table$gov_inter_chance_aut[y-1] +
        ( ((1 - auxilary_table$rel_bio_aut[y-1]) * biodiversity_on_gov_concern) + 
            ((auxilary_table$rel_water_cont_aut[y-1] - 1) * water_contamination_on_gov_concern))
      # chance for government intervention.
      # government intervention instantaneous but calculated on values government_reaction_time years before.
      intervention_delay <- ifelse(government_reaction_time <= y,
                                   0,
                                   y - government_reaction_time)
      auxilary_table$gov_inter_happened_man[y] <- ifelse(auxilary_table$gov_inter_happened_man[y-1] == 0,
                                                     chance_event(auxilary_table$gov_inter_chance_man[intervention_delay],1, 0, 1),
                                                     1)
      auxilary_table$gov_inter_happened_aut[y] <- ifelse(auxilary_table$gov_inter_happened_aut[y-1] == 0,
                                                     chance_event(auxilary_table$gov_inter_chance_aut[intervention_delay],1, 0, 1),
                                                     1)
      
      # potential plant damagex
      auxilary_table$plant_dmg_pot_man[y] <- potential_plant_damage
      auxilary_table$plant_dmg_pot_aut[y] <- auxilary_table$plant_dmg_pot_man[y]
      # pesticide quantity
      auxilary_table$pest_quant_man[y] <- pesticide_quantity
      auxilary_table$pest_quant_aut[y] <- auxilary_table$pest_quant_man[y] * pest_red_fac
      # water contamination ## assuming that the pesticide quantity influences the water contamination by 10%
      auxilary_table$rel_water_cont_man[y] <- auxilary_table$rel_water_cont_man[y-1] +
        ((1 - auxilary_table$pest_quant_man[y-1]) * pest_cont_fac)
      auxilary_table$rel_water_cont_aut[y] <- auxilary_table$rel_water_cont_aut[y-1] +
        ((1 - auxilary_table$pest_quant_aut[y-1]) * pest_cont_fac)
      
      # biodiversity ## assuming that the water contamination influences the biodiversity by 10%
      auxilary_table$rel_bio_man[y] <- auxilary_table$rel_bio_man[y-1] +
        ((1 - auxilary_table$pest_quant_man[y-1]) * pest_bio_fac) + ((1 - auxilary_table$rel_water_cont_man[y-1]) * cont_bio_fac)
      
      auxilary_table$rel_bio_aut[y] <- auxilary_table$rel_bio_aut[y-1] +
        ((1 - auxilary_table$pest_quant_aut[y-1]) * pest_bio_fac) + ((1 - auxilary_table$rel_water_cont_aut[y-1]) * cont_bio_fac)
      
      # potential plant damage ## effected by biodiversity
      auxilary_table$plant_dmg_pot_man[y] <- auxilary_table$plant_dmg_pot_man[y-1] +
        auxilary_table$plant_dmg_pot_man[y-1] * (1 -  auxilary_table$rel_bio_man[y-1])
      auxilary_table$plant_dmg_pot_aut[y] <- auxilary_table$plant_dmg_pot_aut[y-1] +
        auxilary_table$plant_dmg_pot_aut[y-1] * (1 -  auxilary_table$rel_bio_aut[y-1])
      # pesticide quantity ## effected by biodiversity
      auxilary_table$pest_quant_man[y] <- auxilary_table$pest_quant_man[y] +
        auxilary_table$pest_quant_man[y] * (1 - auxilary_table$rel_bio_man[y])
      auxilary_table$pest_quant_aut[y] <- auxilary_table$pest_quant_aut[y] +
        auxilary_table$pest_quant_aut[y] * (1 - auxilary_table$rel_bio_aut[y])
      
      auxilary_table$pest_quant_man[y] <- ifelse(auxilary_table$gov_inter_happened_man[y] == 0,
                                                 auxilary_table$pest_quant_man[y],
                                                 ifelse(auxilary_table$pest_quant_man[y] > government_pesticide_quantity,
                                                        government_pesticide_quantity,
                                                        auxilary_table$pest_quant_man[y]))
      
      auxilary_table$pest_quant_aut[y] <- ifelse(auxilary_table$gov_inter_happened_aut[y] == 0,
                                                 auxilary_table$pest_quant_aut[y],
                                                 ifelse(auxilary_table$pest_quant_aut[y] > government_pesticide_quantity,
                                                        government_pesticide_quantity,
                                                        auxilary_table$pest_quant_aut[y]))
      
      # actual plant damage ## potential plant damage - pesticide quantity 
      actual_plant_dmg_man <- auxilary_table$plant_dmg_pot_man[y] - auxilary_table$pest_quant_man[y]
      auxilary_table$actual_plant_dmg_man[y] <- ifelse(actual_plant_dmg_man < 0, 0, actual_plant_dmg_man)
      ### auxilary_table$actual_plant_dmg_man[y] <- actual_plant_dmg_man
      actual_plant_dmg_aut <- auxilary_table$plant_dmg_pot_aut[y] - auxilary_table$pest_quant_aut[y] / pest_red_fac
      auxilary_table$actual_plant_dmg_aut[y] <- ifelse(actual_plant_dmg_aut < 0, 0, actual_plant_dmg_aut)
      ### auxilary_table$actual_plant_dmg_aut[y] <- actual_plant_dmg_aut
    }
    
  }
  print(auxilary_table)

>>>>>>> 250aa3616f416275080e82c7a85c8f95143bcdce
  
  # chance_event() government
  # pest_quant_gov <- vv(government_pesticide_quantity, 10, n_years)
  
  
  # yields prizes are varying depending on the years and the plant damage
  yield_t_ha <- vv(yield, var_CV, n_years)
  yield_t_ha_man <- yield_t_ha * (1 - auxilary_table$actual_plant_dmg_man)
  yield_t_ha_aut <- yield_t_ha * (1 - auxilary_table$actual_plant_dmg_aut)
  # market prizes are varying over the years
  market_price_e_t <- vv(market_price, var_CV, n_years)
  # fruit sales depend on yield and market price
  fruit_sales_e_ha_man <- yield_t_ha_man * market_price_e_t
  fruit_sales_e_ha_aut <- yield_t_ha_aut * market_price_e_t
  
  # costs for pesticides per ha and decision
  pest_cost_ha_const <- vv( pesticide_cost, var_CV, n_years )
  pest_cost_ha_man <- pest_cost_ha_const * auxilary_table$pest_quant_man
  pest_cost_ha_aut <- pest_cost_ha_const * auxilary_table$pest_quant_aut
  # machine costs are applied only once so n = 1
  machine_upg_cost <- c( initial_upg_cost, rep(0,(n_years-1)) )

  
  ##### profit - depends an the fruit sales and the pesticide costs per hectare 
  # resulting profit gets multiplied by the number of hectares
  # for the automated option the machine upgrade cost get substracted 
  farmers_profit_man = (fruit_sales_e_ha_man - pest_cost_ha_man) * area_per_machine
  farmers_profit_aut = (fruit_sales_e_ha_aut - pest_cost_ha_aut) * area_per_machine - machine_upg_cost

  ##### NPV - the value of money in the future gets discounted
  # 2 - 5 % since our farmers are likely to invest
  NPV_aut = discount(farmers_profit_aut, discount_rate, calculate_NPV = TRUE)
  NPV_man = discount(farmers_profit_man, discount_rate, calculate_NPV = TRUE)

  
  return(list(Interv_NPV = NPV_aut,
              NO_Interv_NPV = NPV_man,
              NPV_decision_do = NPV_aut - NPV_man,
              Cashflow_decision_do = farmers_profit_aut - farmers_profit_man))
}


## Importing input table 
  input_table <- read.csv("data/input_data_03.csv", sep = ";", dec = ",")
  input_table <- drop_na(input_table, c("lower","upper"))
  write.csv(input_table, "data/final/inputs.csv", row.names = FALSE)
  input_table <- read.csv("data/final/inputs.csv")
  # as.estimate(input_table) 

## creating Correlation matrix 
estimateTextCor<-",                       potential_plant_damage, pesticide_quantity
                  potential_plant_damage,                      1,               0.9
                  pesticide_quantity,                        0.9,                1"
correlation_matrix <- data.matrix( read.csv( text=estimateTextCor, row.names=1, strip.white=TRUE))

## adding the input table and the correlation matrix to the estimate object
#inputs <- as.estimate(input_table, correlation_matrix = correlation_matrix)

## Perform a Monte Carlo simulation 
mcSimulation_results <- decisionSupport::mcSimulation(
  #  estimate = decisionSupport::estimate_read_csv("data/final/inputs.csv"),
  estimate = as.estimate(input_table, correlation_matrix = correlation_matrix),
  model_function = ascs_decision_model,
  numberOfModelRuns = 10,
  functionSyntax = "plainNames"
)


## Plot Net Present Value (NPV) distributions 
decisionSupport::plot_distributions(mcSimulation_object = mcSimulation_results, 
                                    vars = c("Interv_NPV", "NO_Interv_NPV"),
                                    method = 'smooth_simple_overlay', 
                                    base_size = 7)

decisionSupport::plot_distributions(mcSimulation_object = mcSimulation_results, 
                                    vars = c("Interv_NPV",
                                             "NO_Interv_NPV"),
                                    method = 'boxplot')

decisionSupport::plot_distributions(mcSimulation_object = mcSimulation_results, 
                                    vars = "NPV_decision_do",
                                    method = 'boxplot_density')


## Cashflow analysis 
plot_cashflow(mcSimulation_object = mcSimulation_results, cashflow_var_name = "Cashflow_decision_do")


## Projection to Latent Structures (PLS) analysis 
pls_result <- plsr.mcSimulation(object = mcSimulation_results,
                                resultName = names(mcSimulation_results$y)[3], ncomp = 1)

plot_pls(pls_result, input_table = input_table, threshold = 0)


## Value of information (VoI) analysis 

# Here we subset the outputs from the mcSimulation function (y) by selecting the correct variables
# choose this carefully and be sure to run the multi_EVPI only on the variables that the you want
mcSimulation_table <- data.frame(mcSimulation_results$x, mcSimulation_results$y[1:3])

evpi <- multi_EVPI(mc = mcSimulation_table, first_out_var = "Interv_NPV")

plot_evpi(evpi, decision_vars = "NPV_decision_do")

compound_figure(mcSimulation_object = mcSimulation_results, 
                input_table = input_table, plsrResults = pls_result, 
                EVPIresults = evpi, decision_var_name = "NPV_decision_do", 
                cashflow_var_name = "Cashflow_decision_do", 
                base_size = 7)


```


<<<<<<< HEAD
```{r, eval = FALSE}
### Seminar 09


## Plot impact pathway
hail_path <- graph.formula(HailNet -+ Yield, 
                           HailNet -+ Cost, 
                           HailEvent -+ Yield,
                           Yield -+ MarketPrice, 
                           MarketPrice -+ NPV,
                           Cost -+ NPV)
plot(hail_path)


## Building the model 
hail_estimates <- data.frame(variable = c("yield", 
                                          "var_CV", 
                                          "initial_investment", 
                                          "price", 
                                          "p_hail"),
                    lower = c(6000, 20, 500, 5, 0.02),
                    median = NA,
                    upper = c(14000, 20, 1000, 80, 0.2),
                    distribution = c("posnorm", 
                                     "const", 
                                     "posnorm", 
                                     "posnorm",
                                     "posnorm"),
                    label = c("Yield (kg/ha)", 
                              "Coefficient of variation", 
                              "Investment cost (USD)", 
                              "Market price (EUR/kg)", 
                              "% chance hail"),
                    Description = c("Yield under normal conditions",
                                    "Coefficient of variation (measure of relativevariability)",
                                    "Investment cost", 
                                    "Market price achieved for yields (EUR/kg)", 
                                    "Probability of a hail storm"))
hail_estimates


## Create a function following the graphical impact pathway and using the inputs above to calculate the Net Present Value for the investment

hail_function <- function(){
  
# use vv() to add variability to the random draws of yield and of price over a 20 year simulation 
yields <- vv(var_mean = yield, 
             var_CV = var_CV, 
             n = 20)

prices <- vv(var_mean = price, 
             var_CV = var_CV, 
             n = 20)

# use rep() to simulate the initial_investment 
# only in the first year (assuming the net lasts 20 years)
invest_costs <- c(initial_investment, rep(0, 19))

# use p_hail in the chance_event() 
# to adjust yield for probability of hail
# assuming no yield at all in the event of hail
hail_adjusted_yield <- chance_event(chance = p_hail, 
                                    value_if = 0,
                                    value_if_not = yield,
                                    n = 20)

# calculate profit without net
profit_no_net <- hail_adjusted_yield*prices

# calculate profit with the net
profit_with_net <- (yields*prices)-invest_costs

# use 'discount' to calculate net present value 
# 'discount_rate' is expressed in percent
NPV_no_net <- discount(profit_no_net, discount_rate = 5, calculate_NPV = TRUE)
NPV_net <- discount(profit_with_net, discount_rate = 5, calculate_NPV = TRUE)

# calculate the overall NPV of the decision (do - don't do)
NPV_decision <- NPV_net-NPV_no_net

return(list(NPV_no_net =  NPV_no_net,
            NPV_net =  NPV_net, 
            NPV_decision = NPV_decision))
}
=======
>>>>>>> 250aa3616f416275080e82c7a85c8f95143bcdce



#### Notes for improvement from the seminar 


**Inspiration from other presentations**  

* Implement "interception" aspect at the base of the model  
* End model with "Overall value"/"NPV" instead of "Farmer's profit" 
* Add legend to the model visualisation  


**Suggestions to improve our model**  
* Orchard size:
  + Keep applicability to many different situations in minds 
  + Create a number of realistic scenarios 
* Estimate maximum area one unit can work on $\Rightarrow$ Set maximum workload as upper boundary 
  + Consider max. speed, max. uninterrupted working hours 
 
 
```

#### Example code from Seminar 08 and Seminar 09 

```{r, eval = FALSE}
library(readr)
library(ggplot2)
library(plyr)
library(dplyr)
library(igraph)
```

### Seminar 08
Model Framework
* Runs for 10 years (Time to be financially feasible)
* One sprayer can handle 15 ha


Assigning model variables to variable type

* Event (`chance_event()`, simulate occurrence of random events), either happens or not
  + Governments concern triggers intervention, which results in the end of the model (less chance to occur for the automated one)
  + Disease infection, chance might be reduced with better biodiversity. Different severities.

* Fix variables
  + Cost of the machines are given (distribution)
  + Pesticides is a yearly necessity (distribution of mean over many years)

* Time-dependent variables (`vv()`, value varier function), variables that change with every iteration
  + Water contamination
  + Customers
  + Biodiversity (maybe using a logistic function?)
  + Fruit sales

* Combined variables
  + Both events are also time dependent, as higher water contamination rises goverments concern and thus an intervention
